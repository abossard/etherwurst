@page "/"
@page "/{Address}"
@rendermode InteractiveServer
@using System.Net.Http
@using System.Text.Json
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation

<PageTitle>Haz Me Been Scammed? 🔍</PageTitle>

<div class="scam-hero">
    <div class="scam-hero-content">
        <h1 class="scam-title">🔍 Haz Me Been Scammed?</h1>
        <p class="scam-subtitle">Enter an Ethereum wallet address or transaction hash to analyze for scam patterns.</p>
    </div>
</div>

<div class="scam-container">
    <div class="scam-input-card">
        <div class="input-group mb-3">
            <input @bind="InputValue"
                   @bind:event="oninput"
                   @onkeydown="HandleKeyDown"
                   class="form-control scam-input"
                   placeholder="0x... (wallet address or transaction hash)"
                   disabled="@IsAnalyzing"
                   aria-label="Ethereum address or transaction hash" />
            <button class="btn btn-analyze"
                    @onclick="StartAnalysis"
                    disabled="@(IsAnalyzing || string.IsNullOrWhiteSpace(InputValue))">
                @if (IsAnalyzing)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <span>Analyzing...</span>
                }
                else
                {
                    <span>🔍 Analyze</span>
                }
            </button>
        </div>
        <div class="sample-inputs">
            <span class="text-muted me-2">Try a sample:</span>
            <button class="btn btn-sm btn-outline-secondary me-1" @onclick='() => SetSample("0x742d35Cc6634C0532925a3b844Bc454e4438f44e")'>
                🦊 Sample Wallet
            </button>
            <button class="btn btn-sm btn-outline-secondary" @onclick='() => SetSample("0x5c504ed432cb51138bcf09aa5e8a410dd4a1e204b93aaa9b6d64c1b0726b9e4b")'>
                📋 Sample Tx
            </button>
        </div>
    </div>

    @if (Events.Count > 0)
    {
        <div class="progress-section">
            @{
                var latest = Events.LastOrDefault();
            }
            @if (latest is not null)
            {
                <div class="progress mb-2">
                    <div class="progress-bar @GetProgressBarClass(latest.Stage)"
                         role="progressbar"
                         style="width: @latest.ProgressPercent%"
                         aria-valuenow="@latest.ProgressPercent"
                         aria-valuemin="0"
                         aria-valuemax="100">
                        @latest.ProgressPercent%
                    </div>
                </div>
                <p class="progress-message text-muted">@latest.Message</p>
            }
        </div>

        @if (FinalResult is not null)
        {
            <div class="result-card @GetVerdictClass(FinalResult.Verdict)">
                <div class="result-header">
                    <span class="result-verdict-icon">@GetVerdictIcon(FinalResult.Verdict)</span>
                    <div>
                        <h2 class="result-verdict">@FinalResult.Verdict.ToString().Replace("LikelyScam", "Likely Scam").Replace("ConfirmedScam", "Confirmed Scam")</h2>
                        <p class="result-summary">@FinalResult.Summary</p>
                    </div>
                    <div class="risk-score-badge @GetScoreBadgeClass(FinalResult.RiskScore)">
                        <span class="score-number">@FinalResult.RiskScore</span>
                        <span class="score-label">Risk Score</span>
                    </div>
                </div>

                @if (FinalResult.Indicators.Count > 0)
                {
                    <div class="indicators-section">
                        <h3>🚩 Detected Indicators</h3>
                        <div class="indicators-list">
                            @foreach (var indicator in FinalResult.Indicators)
                            {
                                <div class="indicator-item indicator-@indicator.Severity.ToString().ToLower()">
                                    <span class="indicator-icon">@GetSeverityIcon(indicator.Severity)</span>
                                    <span class="indicator-text">@indicator.Description</span>
                                    <span class="indicator-type badge">@indicator.Type</span>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (FinalResult.Transactions.Count > 0)
                {
                    <div class="transactions-section">
                        <h3>📋 Transactions Analyzed (@FinalResult.Transactions.Count total)</h3>

                        @if (CombinedRiskScore is not null)
                        {
                            <div class="combined-score-bar mb-3 p-3 rounded" style="background: var(--bs-body-bg); border: 1px solid var(--bs-border-color);">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>
                                        <strong>🔗 Combined Risk Score</strong>
                                        <small class="text-muted ms-2">(own 40% + counterparty avg 60%)</small>
                                    </span>
                                    <span class="badge fs-6 @GetScoreBadgeClass(CombinedRiskScore.Value)">
                                        @CombinedRiskScore
                                    </span>
                                </div>
                                @if (DeepAnalysisMessage is not null)
                                {
                                    <small class="text-muted d-block mt-1">@DeepAnalysisMessage</small>
                                }
                            </div>
                        }

                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Hash</th>
                                        <th>From</th>
                                        <th>From Risk</th>
                                        <th>To / Contract</th>
                                        <th>To Risk</th>
                                        <th>Value</th>
                                        <th>Token</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var tx in FinalResult.Transactions)
                                    {
                                        <tr class="@(tx.Status == "Failed" ? "table-danger" : "")">
                                            <td><a href="/@tx.Hash" class="addr-link"><code class="hash-cell">@tx.Hash[..10]…</code></a></td>
                                            <td><a href="/@tx.From" class="addr-link"><code class="addr-cell">@tx.From[..8]…</code></a></td>
                                            <td>@RiskBadge(tx.From)</td>
                                            <td>
                                                @if (tx.ContractName is not null)
                                                {
                                                    <a href="/@tx.To" class="addr-link"><span class="badge bg-success">@tx.ContractName</span></a>
                                                }
                                                else if (tx.IsContractInteraction)
                                                {
                                                    <a href="/@tx.To" class="addr-link"><span class="badge bg-warning text-dark">⚠️ Unverified Contract</span></a>
                                                }
                                                else
                                                {
                                                    <a href="/@tx.To" class="addr-link"><code class="addr-cell">@tx.To[..8]…</code></a>
                                                }
                                            </td>
                                            <td>@RiskBadge(tx.To)</td>
                                            <td>@(tx.ValueEth > 0 ? $"{tx.ValueEth:F4} ETH" : "-")</td>
                                            <td>@(tx.TokenAmount > 0 ? $"{tx.TokenAmount:N0} {tx.TokenSymbol}" : "-")</td>
                                            <td><span class="badge @(tx.Status == "Success" ? "bg-success" : "bg-danger")">@tx.Status</span></td>
                                            <td>@tx.Timestamp.ToString("yyyy-MM-dd HH:mm")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>
        }

        @if (ErrorMessage is not null)
        {
            <div class="alert alert-danger mt-3">
                <strong>Error:</strong> @ErrorMessage
            </div>
        }
    }
</div>

@code {
    private string InputValue { get; set; } = "";
    private bool IsAnalyzing { get; set; }
    private List<AnalysisProgressEvent> Events { get; } = [];
    private AnalysisProgressEvent? LatestEvent => Events.LastOrDefault();
    private ScamAnalysisResult? FinalResult { get; set; }
    private string? ErrorMessage { get; set; }
    private Dictionary<string, CounterpartyRiskEvent> CounterpartyRisks { get; } = new(StringComparer.OrdinalIgnoreCase);
    private int? CombinedRiskScore { get; set; }
    private string? DeepAnalysisMessage { get; set; }

    [Parameter] public string? Address { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrWhiteSpace(Address))
        {
            InputValue = Address;
            await StartAnalysis();
        }
    }

    private void SetSample(string sample)
    {
        InputValue = sample;
        StateHasChanged();
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await StartAnalysis();
    }

    private async Task StartAnalysis()
    {
        if (string.IsNullOrWhiteSpace(InputValue) || IsAnalyzing) return;

        Events.Clear();
        FinalResult = null;
        ErrorMessage = null;
        CounterpartyRisks.Clear();
        CombinedRiskScore = null;
        DeepAnalysisMessage = null;
        IsAnalyzing = true;
        StateHasChanged();

        try
        {
            // Update URL so people can share the link
            var trimmed = InputValue.Trim();
            Navigation.NavigateTo($"/{Uri.EscapeDataString(trimmed)}", replace: true);

            var client = HttpClientFactory.CreateClient("api");
            var url = $"/api/analyze?input={Uri.EscapeDataString(InputValue.Trim())}";

            using var response = await client.GetAsync(url, HttpCompletionOption.ResponseHeadersRead);
            response.EnsureSuccessStatusCode();

            using var stream = await response.Content.ReadAsStreamAsync();
            using var reader = new System.IO.StreamReader(stream);

            while (!reader.EndOfStream)
            {
                var line = await reader.ReadLineAsync();
                if (line?.StartsWith("data: ") == true)
                {
                    var json = line[6..];
                    var evt = JsonSerializer.Deserialize<AnalysisProgressEvent>(json,
                        new JsonSerializerOptions(JsonSerializerDefaults.Web)
                        {
                            Converters = { new System.Text.Json.Serialization.JsonStringEnumConverter(System.Text.Json.JsonNamingPolicy.CamelCase) }
                        });
                    if (evt is not null)
                    {
                        Events.Add(evt);
                        if (evt.Result is not null)
                            FinalResult = evt.Result;
                        if (evt.CounterpartyRisk is not null)
                        {
                            CounterpartyRisks[evt.CounterpartyRisk.Address] = evt.CounterpartyRisk;
                            CombinedRiskScore = evt.CounterpartyRisk.CombinedRiskScore;
                            DeepAnalysisMessage = evt.Message;
                        }
                        if (evt.Stage == AnalysisStage.DeepAnalysisComplete)
                            DeepAnalysisMessage = evt.Message;
                        if (evt.Stage == AnalysisStage.Failed)
                            ErrorMessage = evt.Message;
                        StateHasChanged();
                        await Task.Yield();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Connection error: {ex.Message}";
        }
        finally
        {
            IsAnalyzing = false;
            StateHasChanged();
        }
    }

    private static string GetProgressBarClass(AnalysisStage stage) => stage switch
    {
        AnalysisStage.Failed => "bg-danger",
        AnalysisStage.Completed => "bg-success",
        _ => "progress-bar-striped progress-bar-animated"
    };

    private static string GetVerdictClass(ScamVerdict verdict) => verdict switch
    {
        ScamVerdict.ConfirmedScam => "result-card-danger",
        ScamVerdict.LikelyScam => "result-card-warning",
        ScamVerdict.Suspicious => "result-card-caution",
        _ => "result-card-safe"
    };

    private static string GetVerdictIcon(ScamVerdict verdict) => verdict switch
    {
        ScamVerdict.ConfirmedScam => "☠️",
        ScamVerdict.LikelyScam => "🚨",
        ScamVerdict.Suspicious => "⚡",
        _ => "✅"
    };

    private static string GetScoreBadgeClass(int score) => score switch
    {
        >= 70 => "score-danger",
        >= 40 => "score-warning",
        >= 15 => "score-caution",
        _ => "score-safe"
    };

    private static string GetSeverityIcon(ScamSeverity severity) => severity switch
    {
        ScamSeverity.Critical => "🔴",
        ScamSeverity.High => "🟠",
        ScamSeverity.Warning => "🟡",
        _ => "🔵"
    };

    private RenderFragment RiskBadge(string address) => builder =>
    {
        if (CounterpartyRisks.TryGetValue(address, out var risk))
        {
            var cls = risk.RiskScore switch
            {
                >= 70 => "bg-danger",
                >= 40 => "bg-warning text-dark",
                >= 15 => "bg-info text-dark",
                _ => "bg-secondary"
            };
            builder.OpenElement(0, "span");
            builder.AddAttribute(1, "class", $"badge {cls}");
            builder.AddAttribute(2, "title", $"{risk.TransactionCount} txs analyzed");
            builder.AddContent(3, risk.RiskScore.ToString());
            builder.CloseElement();
        }
        else if (DeepAnalysisMessage is not null)
        {
            builder.OpenElement(0, "span");
            builder.AddAttribute(1, "class", "spinner-border spinner-border-sm text-muted");
            builder.AddAttribute(2, "role", "status");
            builder.CloseElement();
        }
    };

    // Local copies of enums/records for the frontend (avoids tight coupling to Core)
    private record AnalysisProgressEvent(
        string AnalysisId,
        AnalysisStage Stage,
        string Message,
        int ProgressPercent,
        ScamAnalysisResult? Result = null,
        CounterpartyRiskEvent? CounterpartyRisk = null);

    private record ScamAnalysisResult(
        string AnalysisId,
        string Input,
        string InputType,
        ScamVerdict Verdict,
        int RiskScore,
        string Summary,
        List<TransactionInfo> Transactions,
        List<ScamIndicator> Indicators,
        DateTimeOffset AnalyzedAt);

    private record TransactionInfo(
        string Hash,
        string From,
        string To,
        decimal ValueEth,
        string TokenSymbol,
        decimal TokenAmount,
        bool IsContractInteraction,
        string? ContractName,
        DateTimeOffset Timestamp,
        string Status);

    private record ScamIndicator(
        string Type,
        string Description,
        ScamSeverity Severity);

    private enum AnalysisStage
    {
        Started, FetchingTransactions, AnalyzingContracts,
        DetectingPatterns, ComputingScore, Completed, DeepAnalysis, DeepAnalysisComplete, Failed
    }

    private record CounterpartyRiskEvent(
        string AnalysisId,
        string Address,
        int RiskScore,
        ScamVerdict Verdict,
        int TransactionCount,
        int CombinedRiskScore);

    private enum ScamVerdict { Clean, Suspicious, LikelyScam, ConfirmedScam }
    private enum ScamSeverity { Info, Warning, High, Critical }
}

