name: etherwurst
metadata:
  template: etherwurst@0.1.0
infra:
  provider: bicep
  path: infra
  module: main
  deploymentStacks:
    actionOnUnmanage:
      resources: detach
      resourceGroups: detach
    denySettings:
      mode: denyDelete
      applyToChildScopes: true
services:
  app:
    project: src/HazMeBeenScammed.AppHost
    host: containerapp
    language: dotnet
hooks:
  preprovision:
    shell: sh
    run: |
      echo "â•â•â• Detecting developer identity..."
      PRINCIPAL_ID=$(az ad signed-in-user show --query id -o tsv 2>/dev/null || true)
      if [ -n "$PRINCIPAL_ID" ]; then
        azd env set AZURE_DEVELOPER_PRINCIPAL_ID "$PRINCIPAL_ID"
        echo "  Developer principal: $PRINCIPAL_ID"
      else
        echo "  No interactive user detected â€” skipping developer RBAC"
        azd env set AZURE_DEVELOPER_PRINCIPAL_ID ""
      fi
      echo "â•â•â• Ensuring resource group exists..."
      RG_NAME="rg-hazscam-${AZURE_ENV_NAME}"
      azd env set AZURE_RESOURCE_GROUP "$RG_NAME"
      az group create --name "$RG_NAME" --location "${AZURE_LOCATION}" -o none 2>/dev/null || true
      echo "  Resource group: $RG_NAME"
  postprovision:
    shell: sh
    run: |
      echo "â•â•â• Ensuring Entra ID app registration..."
      APP_NAME="${AZURE_ENV_NAME}-app"
      APP_ID=$(az ad app list --display-name "$APP_NAME" --query '[0].appId' -o tsv 2>/dev/null)
      if [ -z "$APP_ID" ]; then
        APP_ID=$(az ad app create --display-name "$APP_NAME" --query appId -o tsv)
        az ad sp create --id "$APP_ID" -o none 2>/dev/null || true
        echo "  Created app registration: $APP_ID"
      else
        echo "  App registration exists: $APP_ID"
      fi
      echo "â•â•â• Getting AKS credentials..."
      az aks get-credentials \
        -g "${AZURE_RESOURCE_GROUP}" \
        -n "${AZURE_AKS_CLUSTER_NAME}" \
        --overwrite-existing
      echo "â•â•â• Installing Flux Operator + Web UI..."
      kubectl create namespace flux-system --dry-run=client -o yaml | kubectl apply -f - 2>/dev/null
      echo "â•â•â• Installing Gateway API CRDs..."
      kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.2.0/standard-install.yaml 2>/dev/null
      echo "  Gateway API CRDs installed"
      helm upgrade --install flux-operator \
        oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator \
        --namespace flux-system \
        --set webUI.enabled=true \
        --wait --timeout 5m 2>&1 | tail -3
      echo "  Flux Operator installed"
      echo "â•â•â• Applying FluxInstance (GitOps sync)..."
      kubectl apply -f clusters/etherwurst/flux-system/flux-instance.yaml
      echo "  FluxInstance applied â€” Flux will now sync from Git"
      echo "â•â•â• Creating cluster-config ConfigMap from azd outputs..."
      kubectl create configmap cluster-config \
        --namespace flux-system \
        --from-literal=ACR_LOGIN_SERVER="${AZURE_CONTAINER_REGISTRY_LOGIN_SERVER}" \
        --from-literal=AZURE_CONTAINER_REGISTRY_NAME="${AZURE_CONTAINER_REGISTRY_NAME}" \
        --from-literal=AZURE_OPENAI_ENDPOINT="${AZURE_OPENAI_ENDPOINT}" \
        --from-literal=AZURE_OPENAI_ACCOUNT_NAME="${AZURE_OPENAI_ACCOUNT_NAME}" \
        --from-literal=AZURE_APP_IDENTITY_CLIENT_ID="${AZURE_APP_IDENTITY_CLIENT_ID}" \
        --from-literal=AZURE_APP_IDENTITY_NAME="${AZURE_APP_IDENTITY_NAME}" \
        --from-literal=AZURE_ALB_IDENTITY_CLIENT_ID="${AZURE_ALB_IDENTITY_CLIENT_ID}" \
        --from-literal=AZURE_STORAGE_ACCOUNT_NAME="${AZURE_STORAGE_ACCOUNT_NAME}" \
        --from-literal=AZURE_APPLICATIONINSIGHTS_CONNECTION_STRING="${AZURE_APPLICATIONINSIGHTS_CONNECTION_STRING}" \
        --from-literal=AZURE_RESOURCE_GROUP="${AZURE_RESOURCE_GROUP}" \
        --from-literal=AZURE_ALB_SUBNET_ID="${AZURE_ALB_SUBNET_ID}" \
        --from-literal=AZURE_AGC_WAF_POLICY_ID="${AZURE_AGC_WAF_POLICY_ID}" \
        --from-literal=AZURE_ADX_CLUSTER_URI="${AZURE_ADX_CLUSTER_URI}" \
        --from-literal=AZURE_ADX_CLUSTER_NAME="${AZURE_ADX_CLUSTER_NAME}" \
        --from-literal=AZURE_ADX_DATABASE_NAME="${AZURE_ADX_DATABASE_NAME}" \
        --from-literal=AZURE_AKS_CLUSTER_NAME="${AZURE_AKS_CLUSTER_NAME}" \
        --from-literal=AZURE_ENV_NAME="${AZURE_ENV_NAME}" \
        --dry-run=client -o yaml | kubectl apply -f -
      echo "  cluster-config ConfigMap created"
      echo "â•â•â• Ensuring developer ADX admin assignment..."
      if [ -n "${AZURE_DEVELOPER_PRINCIPAL_ID}" ] && [ -n "${AZURE_ADX_CLUSTER_NAME}" ]; then
        ASSIGN_NAME=$(python3 -c "import uuid; print(uuid.uuid5(uuid.NAMESPACE_URL, '${AZURE_ADX_CLUSTER_NAME}/ethereum/${AZURE_DEVELOPER_PRINCIPAL_ID}/Admin'))")
        az rest --method PUT \
          --url "https://management.azure.com/subscriptions/${AZURE_SUBSCRIPTION_ID}/resourceGroups/${AZURE_RESOURCE_GROUP}/providers/Microsoft.Kusto/clusters/${AZURE_ADX_CLUSTER_NAME}/databases/${AZURE_ADX_DATABASE_NAME}/principalAssignments/${ASSIGN_NAME}?api-version=2024-04-13" \
          --body "{\"properties\":{\"principalId\":\"${AZURE_DEVELOPER_PRINCIPAL_ID}\",\"principalType\":\"User\",\"role\":\"Admin\"}}" \
          -o none 2>/dev/null && echo "  âœ“ ADX developer admin" || echo "  âš  ADX admin assignment (may already exist)"
      fi
      echo "â•â•â• Waiting for Flux controllers..."
      for ctrl in source-controller kustomize-controller helm-controller; do
        kubectl rollout status deployment/"$ctrl" -n flux-system --timeout=120s 2>/dev/null \
          && echo "  âœ“ $ctrl" || echo "  âš  $ctrl: not ready yet (will reconcile)"
      done
      echo "â•â•â• Generating VPN client config..."
      if [ -n "${AZURE_VPN_GATEWAY_NAME}" ]; then
        VPN_URL=$(az network vnet-gateway vpn-client generate \
          -g "${AZURE_RESOURCE_GROUP}" \
          -n "${AZURE_VPN_GATEWAY_NAME}" \
          -o tsv 2>/dev/null || true)
        if [ -n "$VPN_URL" ]; then
          echo "  Download VPN config: $VPN_URL"
          echo ""
          echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "  â•‘  VPN Setup Instructions:                                â•‘"
          echo "  â•‘  1. Install 'Azure VPN Client' from your app store      â•‘"
          echo "  â•‘     macOS: App Store â†’ 'Azure VPN Client'               â•‘"
          echo "  â•‘     Windows: Microsoft Store â†’ 'Azure VPN Client'       â•‘"
          echo "  â•‘  2. Download the zip from the URL above                 â•‘"
          echo "  â•‘  3. Extract and open AzureVPN/azurevpnconfig.xml        â•‘"
          echo "  â•‘  4. In Azure VPN Client: + â†’ Import â†’ select the xml   â•‘"
          echo "  â•‘  5. Connect â€” authenticate with your Entra ID           â•‘"
          echo "  â•‘  6. You're now on the VNet (10.0.0.0/16)               â•‘"
          echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        else
          echo "  VPN Gateway still provisioning â€” run later:"
          echo "    az network vnet-gateway vpn-client generate -g ${AZURE_RESOURCE_GROUP} -n ${AZURE_VPN_GATEWAY_NAME} -o tsv"
        fi
      else
        echo "  VPN Gateway not deployed (privateNetworking=false) â€” skipping"
      fi
      echo "â•â•â• Done! ðŸŽ‰"
      echo ""
      echo "  Flux Web UI: kubectl -n flux-system port-forward svc/flux-operator 9080:9080"
      echo "  Then open:   http://localhost:9080"
  predown:
    shell: sh
    run: |
      echo "â•â•â• Removing Entra ID app registration..."
      APP_NAME="${AZURE_ENV_NAME}-app"
      APP_OBJ=$(az ad app list --display-name "$APP_NAME" --query '[0].id' -o tsv 2>/dev/null)
      if [ -n "$APP_OBJ" ]; then
        az ad app delete --id "$APP_OBJ" -o none
        echo "  Deleted"
      fi
